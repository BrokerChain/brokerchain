// auto generated by dev/system

import { Logger } from "../../../myutils/logger.js";
import { Input, Output, Callback } from "./type.js";
import { html, head, meta, title, body, div, script, link } from "../../../myutils/common/html/index.js";
import * as dir from "../../../myutils/node/dir/index.js";
import { analytics } from "../_analytics/index.js";
import { classic } from "../../../myutils/node/classic.js";
const { __dirname } = classic(import.meta.url);

export async function core<R>(log: Logger, input: Input, cb: Callback<R>): Promise<R> {
    try {
        const { entry_module_path, tailwind_style_path } = make_path(log);

        const page_html = html(
            head(
                meta().attr({
                    charset: "UTF-8"
                }),
                meta().attr({
                    name: "viewport",
                    content: "width=device-width, initial-scale=1.0"
                }),
                title("node"),
                ...analytics(),

                link().attr({
                    href: tailwind_style_path,
                    rel: "stylesheet"
                }),

                script().src(entry_module_path).attr({
                    type: "module"
                })
            ),
            body(div().attr_id("root"))
        );

        return cb.ok({
            html: page_html.to_text(log, {
                ok: (text) => {
                    return text;
                },
                fail: (err) => {
                    throw err;
                }
            })
        });
    } catch (err) {
        log.print_unknown_error(err);
        return cb.fail(err);
    }
}

function make_path(log: Logger) {
    const entry_module_path_abs = dir.resolve(__dirname, "../_page-node/index.js");
    log.variable("entry_module_path_abs", entry_module_path_abs);

    const entry_module_path = entry_module_path_abs.substring(entry_module_path_abs.indexOf("/dist/"));
    log.variable("entry_module_path", entry_module_path);

    // [note]
    // use the tailwind.style.css file in the src directory (tsc won't copy it...)
    // use the taiwind.config.js file in the dist directory

    const tailwind_style_path_abs = dir.resolve(__dirname, "../_page-node/_tailwind/tailwind.style.css");
    log.variable("tailwind_style_path_abs", tailwind_style_path_abs);

    const tailwind_style_path = tailwind_style_path_abs.substring(tailwind_style_path_abs.indexOf("/dist/")).replace("/dist/", "/src/");
    log.variable("tailwind_style_path", tailwind_style_path);

    return { entry_module_path, tailwind_style_path };
}
