// auto generated by dev/system

import * as http from "node:http";
import * as https from "node:https";
import * as path from "node:path";
import express from "express";
import cors from "cors";
import compression from "compression";
import { Logger } from "../../../myutils/logger.js";
import { classic } from "../../../myutils/node/classic.js";
import { load_server_cert } from "./load_server_cert.js";
const { __dirname } = classic(import.meta.url);

import { handle_rpc_export_zip_file } from "../export-zip-file/rpc/handle.js";
import { handle_rpc_disk_collection_ls } from "../disk-collection-ls/rpc/handle.js";
import { handle_rpc_disk_collection_load } from "../disk-collection-load/rpc/handle.js";
import { handle_rpc_disk_collection_save } from "../disk-collection-save/rpc/handle.js";
import { handle_rpc_disk_collection_item_get } from "../disk-collection-item-get/rpc/handle.js";
import { handle_rpc_disk_collection_item_add } from "../disk-collection-item-add/rpc/handle.js";
import { handle_rpc_disk_collection_item_del } from "../disk-collection-item-del/rpc/handle.js";
import { handle_rpc_disk_collection_dirname_resolve } from "../disk-collection-dirname-resolve/rpc/handle.js";
import { handle_rpc_cache_collection_get } from "../cache-collection-get/rpc/handle.js";
import { handle_rpc_cache_collection_set } from "../cache-collection-set/rpc/handle.js";
import { handle_rpc_queue_collection_all_load } from "../queue-collection-all-load/rpc/handle.js";
import { handle_rpc_queue_collection_load } from "../queue-collection-load/rpc/handle.js";
import { handle_rpc_queue_collection_save } from "../queue-collection-save/rpc/handle.js";
import { handle_rpc_collection_get } from "../collection-get/rpc/handle.js";
import { handle_rpc_collection_get_one } from "../collection-get-one/rpc/handle.js";
import { handle_rpc_collection_item_add } from "../collection-item-add/rpc/handle.js";
import { handle_rpc_collection_item_del } from "../collection-item-del/rpc/handle.js";

// the name begins with underscore to avoid name conflicts with the imported items
export function _start(plog: Logger, opt: { host: string; http_port: number; https_port: number; setup?: (exp_app: express.Express) => void }) {
    const log = plog.sub("server.start");
    log.variable("opt", opt);
    const exp_app = express();
    exp_app.use(cors());
    exp_app.use(compression());
    exp_app.use(express.static(path.resolve(__dirname, "../_webroot")));
    exp_app.use(
        express.json({
            limit: "100mb"
        })
    );
    // auto display the index page (redirect to)
    exp_app.get("/", (req, res) => {
        res.redirect("/index/");
    });
    // additional setup (if needed)
    if (opt.setup) {
        opt.setup(exp_app);
    }

    exp_app.post("/library/storage-simple-coll/export-zip-file", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.export-zip-file");
        handle_rpc_export_zip_file(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-ls", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-ls");
        handle_rpc_disk_collection_ls(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-load", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-load");
        handle_rpc_disk_collection_load(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-save", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-save");
        handle_rpc_disk_collection_save(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-item-get", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-item-get");
        handle_rpc_disk_collection_item_get(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-item-add", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-item-add");
        handle_rpc_disk_collection_item_add(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-item-del", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-item-del");
        handle_rpc_disk_collection_item_del(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/disk-collection-dirname-resolve", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.disk-collection-dirname-resolve");
        handle_rpc_disk_collection_dirname_resolve(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/cache-collection-get", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.cache-collection-get");
        handle_rpc_cache_collection_get(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/cache-collection-set", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.cache-collection-set");
        handle_rpc_cache_collection_set(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/queue-collection-all-load", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.queue-collection-all-load");
        handle_rpc_queue_collection_all_load(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/queue-collection-load", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.queue-collection-load");
        handle_rpc_queue_collection_load(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/queue-collection-save", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.queue-collection-save");
        handle_rpc_queue_collection_save(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/collection-get", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.collection-get");
        handle_rpc_collection_get(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/collection-get-one", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.collection-get-one");
        handle_rpc_collection_get_one(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/collection-item-add", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.collection-item-add");
        handle_rpc_collection_item_add(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    exp_app.post("/library/storage-simple-coll/collection-item-del", (req, res) => {
        const input = req.body;
        const req_log = log.sub("post.library.storage-simple-coll.collection-item-del");
        handle_rpc_collection_item_del(req_log, input, {
            invalid_input: (err) => {
                // bad request
                req_log.error(err);
                res.status(400);
                res.end(err.message);
            },
            ok: (result) => {
                // include normal fail case
                req_log.variable("result", result);
                req_log.ok();
                res.json(result);
            },
            fail: (err) => {
                // internal error (not normal fail)
                req_log.error(err);
                res.status(500);
                res.end(err.message);
            }
        });
    });

    // unsafe!
    exp_app.post("/library/:lib_name/:fun_name", (req, res) => {
        const { lib_name, fun_name } = req.params;
        const req_log = log.sub(`post-unsafe.library.${lib_name}.${fun_name}`);
        req_log.variable("params", req.params);
        const input = req.body;
        req_log.variable("input", input);
        import(`../../${lib_name}/${fun_name}/rpc/handle.js`)
            .then((mod) => {
                const fun_code_name = fun_name.replace(/-/g, "_");
                const target_export_fun_name = `handle_rpc_${fun_code_name}`;
                const fun = mod[target_export_fun_name];
                if (typeof fun !== "function") {
                    const err = req_log.new_error(`function is not exported: ${target_export_fun_name}, but got: ${Object.keys(mod)}`);
                    res.status(404);
                    res.end(err.message);
                    return;
                }

                fun(req_log, input, {
                    invalid_input: (err: any) => {
                        // bad request
                        req_log.error(err);
                        res.status(400);
                        res.end(err.message);
                    },
                    ok: (result: any) => {
                        // include normal fail case
                        req_log.variable("result", result);
                        req_log.ok();
                        res.json(result);
                    },
                    fail: (err: any) => {
                        // internal error (not normal fail)
                        req_log.error(err);
                        res.status(500);
                        res.end(err.message);
                    }
                });
            })
            .catch((err) => {
                req_log.error(err);
                res.status(404);
                res.end(`module not found: ${lib_name}/${fun_name}`);
            });
    });

    const http_server = http.createServer(exp_app);
    const https_server = https.createServer(
        {
            SNICallback: (domain, cb) => {
                load_server_cert(log, domain, {
                    ok: (ctx) => {
                        cb(null, ctx);
                    },
                    fail: (err) => {
                        cb(err, null);
                    }
                });
            }
        },
        exp_app
    );

    http_server.on("error", (err) => {
        log.sub("http_server").error(err);
    });

    https_server.on("error", (err) => {
        log.sub("https_server").error(err);
    });

    http_server.listen(opt.http_port, opt.host);
    https_server.listen(opt.https_port, opt.host);

    log.println(`http://${opt.host}:${opt.http_port}`);
    log.println(`https://${opt.host}${opt.https_port ? ":" + opt.https_port : ""}`);
}
